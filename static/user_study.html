<!doctype html>
<html lang="en">
<head>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS -->
    <!--link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"-->
    <link rel="stylesheet" href="css/bootstrap@4.4.1.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- Icon -->
    <link rel="apple-touch-icon" sizes="57x57" href="favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="static/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>Mapper on Graphs</title>

    <!--script src="https://d3js.org/d3.v4.min.js"
            integrity="sha384-1EOYqz4UgZkewWm70NbT1JBUXSQpOIS2AaJy6/evZH+lXOrt9ITSJbFctNeyBoIJ"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"
            integrity="sha384-hX5odjoulJel81+3dsnorXlZ7kA46f8qrV+2sBCcEAXaCyEAiRusFRjaefWw2NPp"
            crossorigin="anonymous"></script-->
    <script src="js/d3@v4.js"></script>
    <script src="js/jquery@3.4.1.js"></script>
    <script src="js/popper@1.16.0.js"></script>
    <script src="js/bootstrap@4.4.1.js"></script>
    <script src="js/d3-scale-chromatic@v1.js"></script>

    <script src="js/menu.js"></script>
    <script src="js/graph.js"></script>
    <script src="js/common.js"></script>
    <script src="js/input.js"></script>

</head>
<body>

<script>
	insert_navbar("user_study.html");
    insert_page_header();
</script>


<div class="page">
    <div class="page-content" id="visualization" style="white-space: nowrap;">
        <div id="graphs_div" style="text-align: left; width: 1200px;"></div>
    </div>
</div>


<script>




    let MOG_Vis = function( svg_name, options, ff ){
        let param_uri = $.param(options)
        let mog_data = null
        let mog_vis = null

        function send_to_cache(){
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "mog_layout?"+param_uri, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            tmp_data = {'nodes':mog_data.nodes,'links':[]};
            mog_data.links.forEach( function(L){
               tmp_data.links.push({'value':L.value,'source':L.source.id,'target':L.target.id});
            });
            xhr.send(JSON.stringify(tmp_data));
        }

        d3.json("mog?" + param_uri, function (error, data) {
            if (error) {
                console.log(error);
            } else {
                mog_data = data
                mog_vis = FDL_Graph_Vis(svg_name, mog_data);
                mog_vis.set_node_radius(d => Math.min( Math.sqrt(d.component_count), 20));
                mog_vis.set_node_color(n=>colorSchemes[ff](n.avg_value));
                mog_vis.set_link_width(d => Math.min( Math.sqrt(d.value), 20)/2 );
                //mog_vis.add_count_labels();
                mog_vis.set_end_callback( ()=>{ mog_vis.zoomFit(); send_to_cache() } );
                mog_vis.load()
            }
        });

        return {
            remove : function(){
                if( mog_vis ) mog_vis.remove();
            }
        }

    }


    function change_dataset() {
        update_datafiles();
        change_datafile();
    }

    let dataset = ['medium'];
    let datafile = ['bcsstk.json', 'bcsstk20.json', 'bcsstk22.json', 'collaboration_network.json',
                        'USair97.json', 'caltech.json', 'map_of_science.json', 'movies.json',
                        'watts_strogatz_graph(100,4,0.05).json', 'watts_strogatz_graph(100,5,0.05).json' ]

    function load_mog(){
        //letters = ['A','B','C','D','E','F'];

        let ds = dataset[0];

        datafile.forEach( function(df){

            if( ! (df in datasets[ds]) ){
                console.log('missing datafile ' + df)
                return
            }

        //let df = datafile[0];
        //let df_base = df.split('.')[0]
        let df_base = df.replaceAll(".","_").replaceAll("(","_").replaceAll(',','_').replaceAll(')','_');

        let possible_ff = ['agd','den_0_5','ecc','fv', 'fv_norm','pr_0_85']
        //possible_ff.forEach( ff=>{
            //document.getElementById("mog_row_"+ff).style.display = "none"
        //})

        ff = []
        if( 'agd' in datasets[ds][df]) ff.push('agd')
        if( 'den_0_5' in datasets[ds][df]) ff.push('den_0_5')
        if( 'ecc' in datasets[ds][df]) ff.push('ecc')
        if( 'fv' in datasets[ds][df]) ff.push('fv')
        else if( 'fv_norm' in datasets[ds][df]) ff.push('fv_norm')
        if( 'pr_0_85' in datasets[ds][df]) ff.push('pr_0_85')

            let new_div = document.createElement("DIV");
            new_div.innerHTML = '<svg height="600" width="600" style="border-style: solid; border-width: 1px;" id="graph_' + df_base + '"></svg>'
            document.getElementById("graphs_div").appendChild(new_div);


        d3.json("graph?dataset=" + ds + "&datafile=" + df, function (error, data) {
            if (error) {
                console.log(error);
            } else {
                graph_vis = FDL_Graph_Vis('#graph_' + df_base, data);
                graph_vis.load();
            }
        });

        ff.forEach( cur_ff=>{

            let new_div = document.createElement("DIV");
            let new_div_html = ''
            for (let j = 0; j < 4; j ++) {
                coverN = 2 + 4 * j;
                new_div_html += '<svg height="300" width="300" style="border-style: solid; border-width: 1px;" id="mog_' + df_base + '_' + cur_ff + '_' + coverN + '"></svg>'
            }
            new_div.innerHTML = new_div_html
            document.getElementById("graphs_div").appendChild(new_div);

            //document.getElementById("mog_row_"+cur_ff).style.display = "block"



            for (let j = 0; j < 4; j ++) {
                coverN = 2 + 4*j;
                let options = {
                    'dataset': ds,
                    'datafile': df,
                    'filter_func': cur_ff,
                    'coverN': coverN,
                    'rank_filter':  false,
                    'coverOverlap': 0,
                    'component_method': 'modularity', /*'connected_components'*/
                    'link_method': 'connectivity',
                    'gcc_only':  false,
                    'mapper_node_size_filter': 0
                }
                MOG_Vis('#mog_' + df_base + '_' + cur_ff + '_' + coverN, options, cur_ff )
                //MOG_Vis("#mog_vis_"+cur_ff+"_"+letters[j], options, cur_ff )

            }
        })
        });

    }

    d3.json( "datasets", function( dinput ) {
        datasets = dinput;
        console.log(datasets)
        load_mog();
    });


</script>

</body>
</html>

