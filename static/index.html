<!doctype html>
<html lang="en">
<head>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">

    <!-- Icon -->
    <link rel="apple-touch-icon" sizes="57x57" href="favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="static/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>Mapper on Graphs</title>

    <script src="https://d3js.org/d3.v4.min.js"
            integrity="sha384-1EOYqz4UgZkewWm70NbT1JBUXSQpOIS2AaJy6/evZH+lXOrt9ITSJbFctNeyBoIJ"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
            integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"
            integrity="sha384-hX5odjoulJel81+3dsnorXlZ7kA46f8qrV+2sBCcEAXaCyEAiRusFRjaefWw2NPp"
            crossorigin="anonymous"></script>

    <script src="js/menu.js"></script>
    <script src="js/graph.js"></script>
    <script src="js/histogram.js"></script>
    <script src="js/draggable_box.js"></script>
    <script src="js/dataDownload.js"></script>
    <script src="js/cover.js"></script>
    <script src="js/common.js"></script>
    <script src="js/input.js"></script>

</head>
<body>

<script>
	insert_navbar("index.html");
    insert_page_header();
</script>

<div class="page">
    <div class="sidebar">
        <h2>Mapper on Graphs</h2>
        <form id="parameterForm">
            <div class="container" style="padding: 0;">
                <div class="row">
                    <div class="col-4" style="padding-right: 3px;">
                        <label for="dataset" style="margin-top: 3px;">Data Set</label>
                    </div>
                    <div class="col-8" style="padding-right: 3px;">
                        <select class="form-control form-control-sm" id="dataset" name="dataset"
                                onchange="change_dataset();"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4" style="padding-right: 3px;">
                        <label for="datafile" style="margin-top: 3px;">Data File</label>
                    </div>
                    <div class="col-8" style="padding-right: 3px;">
                        <select class="form-control form-control-sm" id="datafile" name="datafile"
                                onchange="change_datafile();"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4" style="padding-right: 3px;">
                        <label for="filter_func" style="margin-top: 3px;">Filter Function</label>
                    </div>
                    <div class="col-8" style="padding-right: 3px;">
                        <select class="form-control form-control-sm" id="filter_func" name="filter_func"
                                onchange="change_filter_func();"></select>
                    </div>
                </div>
                <!--
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="true" id="rank_filter" name="rank_filter"
                           onchange="change_filter_func();">
                    <label class="form-check-label" for="rank_filter">
                        Rank Filter Values?
                    </label>
                </div>-->

                                <div class="d-inline-block align-middle" style="text-align: center;">
                                <script>
                                    let rank_cg = generate_checkbox('rank_filter','Use Rank Filter','change_filter_func()', 200)
                                    document.write(rank_cg.getHTML())
                                </script>
                                </div>
            </div>


            <div class="accordion" id="accordionExample">
                <div class="card">
                    <div class="card-header" id="headingOne">
                        <h5 class="mb-0">
                            <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne"
                                    aria-expanded="true" aria-controls="collapseOne">
                                Cover Parameters
                            </button>
                        </h5>
                    </div>

                    <div id="collapseOne" class="collapse show" aria-labelledby="headingOne"
                         data-parent="#accordionExample">
                        <div class="card-body">
                            <div class="form-group">
                                <label for="coverN">Cover Elements: <span id="coverN_value">2</span></label>
                                <input type="range" class="custom-range" min="2" max="10" step="1" value="2" id="coverN"
                                       name="coverN"
                                       onchange="change_cover(); document.getElementById('coverN_value').innerHTML = document.getElementById('coverN').value;">
                            </div>
                            <div class="form-group">
                                <label for="coverOverlap">Cover Overlap: <span
                                        id="coverOverlap_value">0.1</span></label>
                                <input type="range" class="custom-range" min="0" max="1" step="0.01" value="0.1"
                                       id="coverOverlap" name="coverOverlap"
                                       onchange="change_cover(); document.getElementById('coverOverlap_value').innerHTML = document.getElementById('coverOverlap').value;">
                            </div>


                            <!--
                            <div class="row">
                                <div class="col-4" style="padding-right: 3px;">
                                    <label for="component_method" style="margin-top: 3px;">Component Method</label>
                                </div>
                                <div class="col-8" style="padding-right: 3px;">
                                    <select class="form-control form-control-sm" id="component_method"
                                            name="component_method" onchange="change_cover();">
                                        <option value="connected_components" selected>Connected Components</option>
                                        <option value="modularity">Modularity</option>
                                        <option value="async_label_prop">Async Label Propagation</option>
                                        <option value="label_prop">Label Propagation</option>
                                        <option value="centrality">Centrality</option>
                                    </select>
                                </div>
                            </div> -->
                                Component Method
                                <div class="d-inline-block align-middle" style="text-align: center;">
                                <script>
                                    let component_rg = generate_radiogroup('component_method',
                                                            [{value:'connected_components',label:'Connected Components',checked:true},
                                                             {value:'modularity',label:'Modularity'},
                                                             {value:'async_label_prop',label:'Async Label Propagation'},
                                                             {value:'label_prop',label:'Label Propagation'},
                                                             {value:'centrality',label:'Centrality'}],
                                                            'change_cover()', 200)
                                    document.write(component_rg.getHTML())
                                </script>
                                </div>

                            <!--
                            <div class="row">
                                <div class="col-4" style="padding-right: 3px;">
                                    <label for="link_method" style="margin-top: 3px;">Connectivity Method</label>
                                </div>
                                <div class="col-8" style="padding-right: 3px;">
                                    <select class="form-control form-control-sm" id="link_method"
                                            name="link_method" onchange="change_cover();">
                                        <option value="overlap" selected>Overlap</option>
                                        <option value="connectivity">Connectivity</option>
                                    </select>
                                </div>
                            </div> -->
                                Connectivity Method
                                <div class="d-inline-block align-middle" style="text-align: center;">
                                <script>
                                    let link_rg = generate_radiogroup('link_method',[
                                                {value:'overlap',label:'Overlap',checked:true},
                                                {value:'connectivity',label:'Connectivity',checked:false}]
                                        ,'change_cover()', 200)
                                    document.write(link_rg.getHTML())
                                </script>
                                </div>

                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header" id="headingTwo">
                            <h5 class="mb-0">
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                                        data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    Graph Filtering
                                </button>
                            </h5>
                        </div>
                        <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo"
                             data-parent="#accordionExample">
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="true" id="gcc_only"
                                           name="gcc_only" onchange="change_cover();">
                                    <label class="form-check-label" for="gcc_only">
                                        Get GCC Only?
                                    </label>
                                </div>

                                <div class="form-group">
                                    <label for="mapper_node_size_filter">Mapper Node Size Filter: <span
                                            id="mapper_node_size_filter_value">0</span></label>
                                    <input type="range" class="custom-range" min="0" max="20" step="1" value="0"
                                           id="mapper_node_size_filter" name="mapper_node_size_filter"
                                           onchange="change_cover(); document.getElementById('mapper_node_size_filter_value').innerHTML = document.getElementById('mapper_node_size_filter').value;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <!-- img src="static/img/viridis.png" width="100%" height="20" -->
    </div>

    <div class="page-content" id="visualization" style="white-space: nowrap;">
        <div style="float: left; text-align: center;">
            <svg height="600" width="600" style="border: thick;" id="graph_vis"></svg>
            <br>
            <input type="button" id="downloadGraph" name="downloadGraph"
                   onclick="downloadJson(graph_data,'graph.json');" value="Download Graph">
        </div>
        <div style="text-align: center; width: 1200px;">
            <svg height="600" width="600" style="border: thick;" id="mog_vis"></svg>
            <br>
            <input type="button" id="downloadMOG" name="downloadMOG"
                   onclick="downloadJson(mog_data,'mog.json');" value="Download MOG">
        </div>
        <input type="button" id="mapperToGraphLayout" name="mapperToGraphLayout"
                   onclick="set_graph_positions_from_mapper();" value="<=== Update Graph Layout From Mapper">
    </div>
</div>


<script>

    var seqColorScheme = d3.scaleSequential().interpolator(d3.interpolateViridis); // .domain([dmin,dmax])
    var catColorScheme = d3.scaleOrdinal().range(d3.schemeSet3); // .domain(graph.nodes, function(n){ return n['type']; } )
    // var catColorScheme = d3.scaleOrdinal( d3.schemeCategory20 );

    let graph_data = null;
    let graph_vis = null;

    let mog_vis = null;
    let mog_data = null;

    let histo_vis = null;
    let cover_vis = null;

    function set_mapper_positions_from_graph(){
        /*
        let tmp = {}
        graph_data.nodes.forEach(function(n){
            tmp[n.id] = n
        })
        mog_data.nodes.forEach(function(m){
            m.x = m.y = 0;
            m.components.forEach(function(n){
                m.x += tmp[n].x
                m.y += tmp[n].y
            })
            m.x = m.x / m.components.length
            m.y = m.y / m.components.length
        })

         */
    }

    function set_graph_positions_from_mapper(){
        /*
        console.log(graph_data)
        let tmp = {}
        let gx = d3.extent( graph_data.nodes, d=>d.x );
        let gy = d3.extent( graph_data.nodes, d=>d.y );
        let mx = d3.extent( mog_data.nodes, d=>d.x );
        let my = d3.extent( mog_data.nodes, d=>d.y );

        let scale = Math.min( ( gx[1]-gx[0] )/( mx[1]-mx[0] ), ( gy[1]-gy[0] )/( my[1]-my[0] ) )
        graph_data.nodes.forEach(function(n){
            tmp[n.id] = n
        })
        mog_data.nodes.forEach(function(m){
            m.components.forEach(function(n){
                tmp[n].x = m.x*scale + Math.random()/10000
                tmp[n].y = m.y*scale + Math.random()/10000
            })
        })
        graph_vis.restart_simulation()
        console.log(tmp)
        console.log(graph_data)

         */
    }

    function update_mog() {
        if( mog_vis ) mog_vis.remove()

        d3.json("mog?" + $("#parameterForm").serialize(), function (error, data) {
            if (error) {
                console.log(error);
            } else {
                mog_data = data;
                //console.log(data)
                /*col_data = {}
                data.nodes.forEach( function(n){
                    col_data[n.id] = n.avg_value;
                });*/

                //$("#mog_vis").empty();

                let maxR = Math.sqrt(d3.max( mog_data.nodes, d=>d.component_count))
                var myScale = d3.scaleLinear()
                      .domain([1, maxR])
                      .range([2, Math.min(20,maxR)]);

                set_mapper_positions_from_graph()
                mog_vis = FDL_Graph_Vis("#mog_vis", mog_data);
                mog_vis.set_node_radius( d => myScale(Math.sqrt(d.component_count)) );
                //mog_vis.update_node_color(colorSchemes[get_selected_filter_func()], col_data);
                mog_vis.set_node_color(colorSchemes[get_selected_filter_func()], n=>n.avg_value );
                mog_vis.set_link_width(d => Math.sqrt(d.value));
                mog_vis.load()

            }
        });

    }

    function change_dataset() {
        update_datafiles();
        load_graph( change_filter_func );
    }

    function change_datafile() {
        update_filter_functions()
        load_graph( change_filter_func );
    }

    function change_filter_func() {
        d3.json("filter_function?" + $("#parameterForm").serialize(), function (error, data) {
            let cs = colorSchemes[get_selected_filter_func()].domain([0,1])
            console.log(data);
            //graph_vis.set_node_color(colorSchemes[get_selected_filter_func()], n=>n, data);
            graph_vis.set_node_color(n=>cs(n), data);

            histo_vis.set_position( 50, 20, 80, 200 );
            histo_vis.update_drawing( 10, Object.values(data) )

            change_cover();
        });
    }

    function change_cover() {
        update_mog();
        cover_vis.set_position( 10, 20, 30, 200 );
        cover_vis.update_drawing( parseFloat(document.getElementById('coverN').value),
                                    parseFloat(document.getElementById('coverOverlap').value) );
    }


    function load_graph(callback) {

        if( graph_vis ) graph_vis.remove()

        let svg = d3.select("#graph_vis")
        svg.empty()
        svg.style("cursor", "progress" )

        d3.json("graph?" + $("#parameterForm").serialize(), function (error, data) {
            if (error) {
                console.log(error);
            } else {
                graph_data = data;
                graph_vis = FDL_Graph_Vis("#graph_vis", data);
                graph_vis.load();
                histo_vis = histogram_vis("#graph_vis");
                cover_vis = cover_visualization("#graph_vis");

                if (callback) callback();
            }
            svg.style("cursor", "auto" )
        });
    }


    load_datasets(change_datafile);

</script>


</body>
</html>

