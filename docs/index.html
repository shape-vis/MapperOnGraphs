<!doctype html>
<html lang="en">
<head>

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS -->
    <!--link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"-->
    <link rel="stylesheet" href="css/bootstrap@4.4.1.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- Icon -->
    <link rel="apple-touch-icon" sizes="57x57" href="favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
    <link rel="manifest" href="favicon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="static/favicon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>Mapper on Graphs</title>

    <script src="js/lib/d3@v4.js"></script>
    <script src="js/lib/jquery@3.4.1.js"></script>
    <script src="js/lib/popper@1.16.0.js"></script>
    <script src="js/lib/bootstrap@4.4.1.js"></script>
    <script src="js/lib/d3-scale-chromatic@v1.js"></script>

    <script src="js/menu.js"></script>
    <script src="js/graph.js"></script>
    <script src="js/histogram.js"></script>
    <script src="js/dataDownload.js"></script>
    <script src="js/cover.js"></script>
    <script src="js/common.js"></script>
    <script src="js/input.js"></script>
    <script src="js/graph_loader.js"></script>

</head>
<body>

<script>
	insert_navbar("index.html");
    insert_page_header();
</script>

<div class="page">
    <div class="sidebar">
        <form id="parameterForm">
            <div class="container" style="padding: 0;">
                <div class="row">
                    <div class="col-4" style="padding-right: 3px;">
                        <label for="dataset" style="margin-top: 3px;">Data Set</label>
                    </div>
                    <div class="col-8" style="padding-right: 3px;">
                        <select class="form-control form-control-sm" id="dataset" name="dataset"
                                onchange="change_dataset();"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4" style="padding-right: 3px;">
                        <label for="datafile" style="margin-top: 3px;">Data File</label>
                    </div>
                    <div class="col-8" style="padding-right: 3px;">
                        <select class="form-control form-control-sm" id="datafile" name="datafile"
                                onchange="change_datafile();"></select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-4" style="padding-right: 3px;">
                        <label for="filter_func" style="margin-top: 3px;">Filter Function</label>
                    </div>
                    <div class="col-8" style="padding-right: 3px;">
                        <select class="form-control form-control-sm" id="filter_func" name="filter_func"
                                onchange="change_filter_func();"></select>
                    </div>
                </div>
                <div class="d-inline-block align-middle" style="text-align: center;">
                    <script>
                        let rank_cg = generate_checkbox('rank_filter','Histogram Equalization','change_filter_func()', 200)
                        document.write(rank_cg.getHTML())
                    </script>
                </div>
                <div class="form-group">
                    <script>
                        let coverN_slider = generate_slider('Cover Elements: ', 'coverN', 2, 20, 1, 2, 'change_cover()')
                        document.write(coverN_slider.getHTML())
                    </script>
                </div>
                Component Method
                <div class="d-inline-block align-middle" style="text-align: center;">
                    <script>
                        let component_rg = generate_radiogroup('component_method',
                                                [{value:'connected_components',label:'Conn. Components',checked:true},
                                                 {value:'modularity',label:'Modularity'},
                                                 {value:'async_label_prop',label:'Async Label Prop'}],
                                                'change_cover()', 200)
                        document.write(component_rg.getHTML())
                    </script>
                </div>

                Connectivity Method
                <div class="d-inline-block align-middle" style="text-align: center;">
                <script>
                    let link_rg = generate_radiogroup('link_method',[{value:'connectivity',label:'Connectivity',checked:true}],'load_mog()', 200)
                    document.write(link_rg.getHTML())
                </script>
                </div>
            </div>
        </form>
    </div>

    <div class="page-content" id="visualization" style="white-space: nowrap;">
        <div style="float: left; text-align: center;">
            <svg height="600" width="600" style="border: thick;" id="graph_vis"></svg>
            <br>
            <input type="button" id="downloadGraph" name="downloadGraph"
                   onclick="downloadJson(graph_vis.get_graph(),'graph.json');" value="Download Graph">
        </div>
        <div style="text-align: center; width: 1200px;">
            <svg height="600" width="600" style="border: thick;" id="mog_vis"></svg>
            <br>
            <input type="button" id="downloadMOG" name="downloadMOG"
                   onclick="downloadJson(mog_vis.get_graph(),'mog.json');" value="Download MOG">
        </div>
    </div>
</div>


<script>


    let graph_vis = null;
    let mog_vis = null;
    let histo_vis = null;
    let cover_vis = null;

    function update_mog() {
        if( mog_vis ) mog_vis.remove()

        let options = {
            'dataset': get_selected_dataset(),
            'datafile': get_selected_datafile(),
            'filter_func': get_selected_filter_func(),
            'coverN': coverN_slider.getValue(),
            'rank_filter':  rank_cg.isChecked(),
            'coverOverlap': 0,
            'component_method': component_rg.getSelected(),
            'link_method': link_rg.getSelected()
        }
        mog_vis = MOG_Vis( "#mog_vis", options )
    }

    function change_dataset() {
        update_datafiles();
        load_graph( change_filter_func );
    }

    function change_datafile() {
        update_filter_functions()
        load_graph( change_filter_func );
    }

    function change_filter_func() {

        let ds = get_selected_dataset()
        let df = get_selected_datafile()
        df = df.substring(0,df.length-5)
        let ff = get_selected_filter_func()

        d3.json("data/" + ds + '/' + df + '/' + ff + '.json', function (error, _data) {

            let data = ( rank_cg.isChecked() ) ? _data['ranked'] : _data['data']

            let cs = colorSchemes[get_selected_filter_func()].domain([0,1])
            graph_vis.set_node_color(n=>cs(n), data);

            histo_vis.set_position( 50, 20, 80, 200 );
            histo_vis.update_drawing( 10, Object.values(data), colorSchemes[get_selected_filter_func()] )

            change_cover();
        });
    }

    function change_cover() {
        let poss_val = [2,3,4,6,8,10,20]
        let closest = poss_val[0]
        let coverN = coverN_slider.getValue()
        poss_val.forEach( v =>{
            if( Math.abs(coverN-v) < Math.abs(coverN-closest) ) closest = v
        })
        coverN = closest

        coverN_slider.setValue(coverN)
        update_mog();
        cover_vis.set_position( 10, 20, 30, 200 );
        cover_vis.update_drawing( coverN, 0, colorSchemes[get_selected_filter_func()] );
    }


    function load_graph(callback) {

        if( graph_vis ) graph_vis.remove()

        let svg = d3.select("#graph_vis")
        //svg.empty()
        svg.style("cursor", "progress" )

        d3.json("data/" + get_selected_dataset() + '/' + get_selected_datafile(), function (error, data) {
            if (error) {
                console.log(error);
            } else {

                graph_vis = FDL_Graph_Vis("#graph_vis", data);
                graph_vis.load();

                if(histo_vis == null) histo_vis = histogram_vis("#graph_vis");
                if(cover_vis == null) cover_vis = cover_visualization("#graph_vis");

                if (callback) callback();
            }
            svg.style("cursor", "auto" )
        });
    }


    load_datasets(change_datafile);

</script>


</body>
</html>

